<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diet√©tica ‚Äî Pedido por WhatsApp</title>
  <meta name="description" content="Cat√°logo simple con carrito y pedido por WhatsApp. HTML, CSS y JS puros." />
  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --panel:#111827;        /* gray-900 */
      --soft:#1f2937;         /* gray-800 */
      --muted:#9ca3af;        /* gray-400 */
      --text:#f8fafc;         /* slate-50 */
      --accent:#22c55e;       /* green-500 */
      --accent-2:#06b6d4;     /* cyan-500 */
      --danger:#ef4444;       /* red-500 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, #0b1024 0%, var(--bg) 60%);
      color:var(--text);
      min-height:100dvh;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(17,24,39,.9), rgba(17,24,39,.6));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .container{max-width:1120px; margin:0 auto; padding:18px 16px;}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:20px; letter-spacing:.3px}
    .brand i{width:28px; height:28px; border-radius:8px; display:inline-grid; place-items:center; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow: var(--shadow);}

    .search{flex:1; min-width:220px; display:flex; gap:8px}
    .search input{flex:1; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:#0b1224; color:var(--text)}
    .search input::placeholder{color:#94a3b8}

    .pillbar{display:flex; gap:8px; overflow:auto; scrollbar-width:none; padding:8px 0 4px}
    .pill{white-space:nowrap; padding:8px 12px; border-radius:999px; background:#0b1224; border:1px solid rgba(255,255,255,.06); color:#cbd5e1; cursor:pointer; font-size:14px}
    .pill.active{background:linear-gradient(135deg, rgba(34,197,94,.18), rgba(6,182,212,.18)); color:#e2e8f0; border-color:rgba(34,197,94,.35)}

    main{padding:20px 16px 120px}

    /* Tarjetas gen√©ricas */
    .grid{max-width:1120px; margin:0 auto; display:grid; grid-template-columns: repeat( auto-fill, minmax(220px, 1fr) ); gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow: var(--shadow); display:flex; flex-direction:column; overflow:hidden}
    .thumb{aspect-ratio: 4/3; background:#0b1224; display:grid; place-items:center; font-size:46px}
    .thumb.hasimg{background-size:cover; background-position:center; font-size:0}
    .content{padding:14px}
    .title{font-weight:700; font-size:16px; line-height:1.2; margin:0 0 6px}
    .desc{color:var(--muted); font-size:13px; min-height:34px}
    .muted{color:#94a3b8; font-size:12px}
    .row-s{display:flex; gap:8px; align-items:center; justify-content:space-between}
    select, button, input[type="number"], textarea{background:#0b1224; color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px}
    select{width:100%}
    .price{font-weight:800}
    .actions{display:flex; gap:8px; margin-top:10px}
    .btn{flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0b1224; color:var(--text); cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#08241a; font-weight:800; border:none}

    /* Floating cart button */
    .fab{
      display:flex; align-items:center; gap:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#06281e; border:none; border-radius:999px;
      padding:12px 16px; font-weight:800; box-shadow: var(--shadow);
      cursor:pointer
    }
    .badge{background:#06131b; color:#e2e8f0; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.18)}

    /* Cart drawer */
    .drawer{position:fixed; top:0; right:0; bottom:0; width:380px; max-width:100vw; background:var(--panel); border-left:1px solid rgba(255,255,255,.08); transform: translateX(100%); transition:transform .28s ease; z-index:40; display:flex; flex-direction:column}
    .drawer.open{transform: translateX(0)}
    .drawer header{position:sticky; top:0; background:rgba(17,24,39,.98); padding:14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,.08)}
    .drawer main{flex:1; overflow:auto; padding:12px 12px 140px}
    .line{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; padding:12px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02); border-radius:14px; margin-bottom:10px}
    .qty{display:flex; align-items:center; gap:6px}
    .qty button{width:28px; height:28px; border-radius:8px}
    .remove{background:transparent; color:#fda4af; border:none; cursor:pointer}

    .totals{position:fixed; right:0; bottom:0; width:380px; max-width:100vw; background:rgba(17,24,39,.98); border-top:1px solid rgba(255,255,255,.08); padding:12px; display:grid; gap:10px; z-index:50}
    .totals .row{justify-content:space-between}
    .notes{width:100%; min-height:72px}
    .select{width:100%}
    .cta{display:flex; gap:8px}

    footer{opacity:.7; text-align:center; padding:26px; font-size:12px}
    a{color:#a5f3fc}

    /* Home de categor√≠as */
    .catsgrid{max-width:1120px; margin:0 auto; display:grid; grid-template-columns: repeat( auto-fill, minmax(240px, 1fr) ); gap:16px}
    .catcard{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow: var(--shadow); padding:18px; display:flex; align-items:center; justify-content:space-between; gap:12px; cursor:pointer}
    .catcard .left{display:flex; align-items:center; gap:12px}
    .catcard .emoji{font-size:28px; width:38px; height:38px; display:grid; place-items:center; border-radius:12px; background:#0b1224; border:1px solid rgba(255,255,255,.06)}
    .catcard .catimg{width:120px; height:120px; border-radius:12px; background:#0b1224 center/cover no-repeat; border:1px solid rgba(255,255,255,.06)}
    .catcard .name{font-weight:800}
    .catcard .count{color:#94a3b8; font-size:12px}

    /* Pantalla de lugares (capa 0) */
    .placesgrid{max-width:820px; margin:0 auto; display:grid; grid-template-columns: repeat( auto-fit, minmax(260px, 1fr) ); gap:16px}
    .placecard{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      cursor:pointer;
      display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center;
    }
    .placeimg{
      width:100%; aspect-ratio: 16/9;
      background:#fff center/contain no-repeat;
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
    }
    .placename{font-weight:900; font-size:18px; letter-spacing:.2px}

    /* Mobile: bot√≥n en el header, alineado a la derecha del brand */
    @media (max-width: 767px){
      header .row{ display:flex; flex-wrap:wrap; align-items:center; }
      .brand{ order:1; }
      .fab{ order:2; margin-left:auto; position:static; }
      .search{ order:3; flex-basis:100%; }
      .pillbar{ margin-top:8px; }
    }
    @media (min-width: 768px){
      .fab{ position:fixed; right:18px; bottom:18px; z-index:30; }
    }

    #closeCartBtn { flex:none; padding:12px 22px; border-radius:30px; }

    /* === Controles iOS-friendly === */
    select, .select,
    input[type="number"], input[type="text"], input[type="search"], textarea {
      font-size: 16px; line-height: 1.35; min-height: 44px; padding: 12px 14px; border-radius: 12px;
    }
    select, .select {
      -webkit-appearance: none; appearance: none; padding-right: 42px;
      background-image: url('data:image/svg+xml;utf8,\
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cbd5e1"><path d="M7 10l5 5 5-5"/></svg>');
      background-repeat: no-repeat; background-position: right 12px center; background-size: 16px 16px;
    }
    @media (max-width: 767px){
      .row-s select, .row-s .select { min-height: 46px; padding: 12px 46px 12px 14px; }
    }
    select:focus, .select:focus, input:focus, textarea:focus { outline: 2px solid rgba(34,197,94,.55); outline-offset: 2px; }

    /* Botoncito utilitario */
    .linkbtn{ background:transparent; color:#a5f3fc; border:1px dashed rgba(165,243,252,.4); padding:8px 12px; border-radius:999px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="brand"><i>ü•ú</i> <span id="storeName">Diet√©tica</span></div>
        <div class="search">
          <input id="searchInput" type="search" placeholder="Buscar: almendras, nuez, sin TACC‚Ä¶" />
        </div>
        <button class="fab" id="openCartBtn" aria-label="Abrir carrito">üõí <span class="badge" id="cartCount">0</span></button>
      </div>
      <div class="pillbar" id="catBar"></div>
    </div>
  </header>

  <main>
    <!-- Capa 0: selecci√≥n de lugar -->
    <section id="placeSelect">
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <h2 style="margin:8px 0 12px">Eleg√≠ tu lugar</h2>
      </div>
      <div class="placesgrid" id="placesGrid"></div>
    </section>

    <!-- Home: mosaico de categor√≠as -->
    <section id="homeCats" style="display:none">
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div>
          <h2 style="margin:8px 0 12px">Explor√° por categor√≠a</h2>
          <div class="muted" id="placeBadge" style="margin-top:-6px"></div>
        </div>
        <button class="linkbtn" id="changePlaceBtn">Cambiar lugar</button>
      </div>
      <div class="catsgrid" id="catsGrid"></div>
    </section>

    <!-- Listado de productos dentro de una categor√≠a -->
    <section id="productList" style="display:none">
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="backToCatsBtn">‚Üê Categor√≠as</button>
          <button class="linkbtn" id="changePlaceBtn2">Cambiar lugar</button>
        </div>
        <div class="muted" id="catTitle"></div>
      </div>
      <div class="grid" id="grid"></div>
    </section>
  </main>

  <!-- Drawer del carrito -->
  <aside class="drawer" id="drawer">
    <header>
      <strong>Tu carrito</strong>
      <button class="btn" id="closeCartBtn">‚úï</button>
    </header>
    <main>
      <div id="cartLines"></div>

      <h4>Datos para el pedido</h4>
      <div class="line" style="grid-template-columns:1fr;">
        <input id="custName" placeholder="Tu nombre" />
        <input id="custArea" placeholder="Barrio / Localidad" style="margin-top:8px" />
        <input id="custAddress" placeholder="Direcci√≥n (opcional)" style="margin-top:8px" />
      </div>

      <div class="line" style="grid-template-columns:1fr;">
        <select id="shippingSelect" class="select"></select>
        <textarea id="notes" class="notes" placeholder="Observaciones (horario, cambios, sin sal, etc.)"></textarea>
      </div>
    </main>

    <div class="totals">
      <div class="row"><span>Subtotal</span><strong id="subtotal">$0</strong></div>
      <div class="row"><span>Env√≠o</span><strong id="shippingCost">$0</strong></div>
      <div class="row"><span>Total</span><strong id="grandTotal">$0</strong></div>
      <div class="cta">
        <button class="btn" id="clearBtn">Vaciar</button>
        <button class="btn primary" id="whatsBtn">Enviar por WhatsApp</button>
      </div>
    </div>
  </aside>

  <footer>
    Hecho con ‚ù§Ô∏è en HTML + JS. Contacto a <em>pablojorgeandres@gmail.com</em>
  </footer>

<script>
/************ CONFIG ************/
const STORE = {
  name: 'Nim√∫ - Tienda Consciente',
  phone: '5491123965312', // Formato internacional sin + ni guiones
  currency: 'ARS',
  freeShippingMin: 30000,
  shippingOptions: [
    { id:'Env√≠o', label:'Env√≠o sin costo', price:0 },
  ]
};

// TU endpoint de Apps Script (termina en /exec)
const PRODUCTS_URL = 'https://script.google.com/macros/s/AKfycbykFiNmtfbVMKDWhD6JDP-R_R8M-e5wszwfum4eHokTBF3ey9y1eatSiKSPNADx_L47/exec';

/**
 * Siluetas (placeholders) ‚Äì reemplaz√° por tus contornos si quer√©s.
 * Pod√©s usar PNG/SVG externos o data-URIs.
 */
const PLACE_SHAPES = {
  santafe: 'https://drive.google.com/thumbnail?id=1o8eKJyWCRDHvVV2CbYHGxQbgmrcml0cg&sz=w800',
  buenosaires: 'https://drive.google.com/thumbnail?id=11RLU0gQ7NDfTPZnKqEQT1F2qq_vaCAqK&sz=w800'
};

/************ DATA ************/
let DATA = {};        // cat√°logo por categor√≠a
let INDEX = [];       // lista de categor√≠as
let PLACES_META = []; // [{id,name}]
let state = {
  view: 'places',     // 'places' | 'home' | 'products'
  place: null,        // 'santafe' | 'buenosaires'
  placeName: '',
  category: null,     // null| 'Frutos Secos' | 'Todo'
  search: '',
  cart: loadCart(),
  shipping: STORE.shippingOptions[0].id
};

/************ UTIL ************/
const fmt = new Intl.NumberFormat('es-AR', { style:'currency', currency: STORE.currency });
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const encode = s => encodeURIComponent(s);

function loadCart(){ try{ return JSON.parse(localStorage.getItem('cart')) || []; } catch { return []; } }
function saveCart(){ localStorage.setItem('cart', JSON.stringify(state.cart)); }

function allItems(){ return INDEX.flatMap(cat => (DATA[cat]?.items)||[]); }

function normalizeImageUrl(u, size=800){
  if(!u) return "";
  if(u.includes("drive.google.com/thumbnail")) return u;
  const m = u.match(/[?&]id=([A-Za-z0-9_-]+)/) || u.match(/\/d\/([A-Za-z0-9_-]+)/);
  const id = m ? m[1] : null;
  return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w${size}` : u;
}

function sanitizeCatalog(data){
  const out = {};
  Object.keys(data || {}).forEach(cat=>{
    const block = data[cat] || {};
    const items = Array.isArray(block.items) ? [...block.items] : [];

    // sentinel para cover
    const idx = items.findIndex(p =>
      String(p?.name||'').trim().toLowerCase() === 'categoryimage' ||
      String(p?.id||'').trim().toLowerCase() === '_cover'
    );

    if (idx >= 0) {
      const raw = items[idx].imageUrl || '';
      block.cover = normalizeImageUrl(raw);
      items.splice(idx, 1);
    }
    if (block.cover) block.cover = normalizeImageUrl(block.cover);

    block.items = items;
    out[cat] = block;
  });
  return out;
}

/************ FETCH ************/
async function fetchPlacesMeta(){
  let safeList = [
    { id: 'santafe', name: 'Santa Fe' },
    { id: 'buenosaires', name: 'Buenos Aires' }
  ];
  try{
    const res = await fetch(`${PRODUCTS_URL}?meta=places&bust=${Date.now()}`, { cache:'no-store' });
    const data = await res.json();
    const looksOk = Array.isArray(data) && data.length &&
      data.every(x => x && typeof x.id === 'string' && typeof x.name === 'string');
    if (looksOk) safeList = data;
  } catch(e){
    console.warn('Usando fallback de lugares:', e);
  }
  PLACES_META = safeList;
  renderPlaces();
}

async function fetchCatalogForPlace(placeId){
  const cacheKey = `catalog_grouped_v3__${placeId}`;
  // 1) cache local
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    try {
      DATA = sanitizeCatalog(JSON.parse(cached));
      INDEX = Object.keys(DATA);
      if (state.view === 'home') renderHomeCats(); else renderGrid();
    } catch(e) { console.warn('Cache corrupta, la ignoro', e); }
  }

  // 2) pedir fresco
  const res = await fetch(`${PRODUCTS_URL}?grouped=true&place=${encode(placeId)}&bust=${Date.now()}`, { cache:'no-store' });
  const fresh = await res.json();
  DATA = sanitizeCatalog(fresh);
  INDEX = Object.keys(DATA);
  localStorage.setItem(cacheKey, JSON.stringify(DATA));
  if (state.view === 'home') renderHomeCats(); else renderGrid();
}

/************ UI: LUGARES ************/
function renderPlaces(){
  const host = $('#placesGrid');
  host.innerHTML = '';

  // Si el backend todav√≠a no define lugares, usamos fallback fijo:
  const list = PLACES_META && PLACES_META.length ? PLACES_META : [
    { id: 'santafe', name: 'Santa Fe' },
    { id: 'buenosaires', name: 'Buenos Aires' }
  ];

  list.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'placecard';
    const bg = PLACE_SHAPES[p.id] || '';
    card.innerHTML = `
      <div class="placeimg" style="${bg ? `background-image:url('${bg}')` : ''}"></div>
      <div class="placename">${p.name}</div>
      <div class="muted">Ver productos disponibles en ${p.name}</div>`;
    card.onclick = async ()=>{
      state.place = p.id;
      state.placeName = p.name;
      $('#placeBadge').textContent = `Lugar: ${state.placeName}`;
      $('#storeName').textContent = `${STORE.name} ‚Äî ${state.placeName}`;
      state.category = 'Todo';
      state.search = '';
      showView('home');
      await fetchCatalogForPlace(state.place);
      renderCategories();
      renderHomeCats();
    };
    host.appendChild(card);
  });
  if(!list.length){ host.innerHTML = `<p class="muted">No hay lugares disponibles.</p>`; }
}

/************ UI: CATEGOR√çAS (p√≠ldoras) ************/
function renderCategories(){
  const bar = $('#catBar');
  bar.innerHTML = '';
  if(state.view !== 'products'){ bar.style.display = 'none'; return; }

  const cats = ['Todo', ...INDEX];
  cats.forEach(c=>{
    const b = document.createElement('button');
    b.className = 'pill' + ((state.category===c)?' active':'');
    b.textContent = c;
    b.onclick = ()=>{
      state.category = c;
      $('#catTitle').textContent = (c==='Todo') ? '' : c;
      renderGrid();
      highlightCat();
    };
    bar.appendChild(b);
  });
  bar.style.display = 'flex';
}
function highlightCat(){ $$('#catBar .pill').forEach(el=>{ el.classList.toggle('active', el.textContent===state.category); }); }

/************ HOME: MOSAICO DE CATEGOR√çAS ************/
function renderHomeCats(){
  const host = $('#catsGrid');
  host.innerHTML = '';
  INDEX.forEach(cat=>{
    const block = DATA[cat] || {cover:'', items:[]};
    let cover = normalizeImageUrl(block.cover || '');
    if (!cover) {
      const alt = (block.items.find(x=>x.imageUrl) || {}).imageUrl || '';
      cover = normalizeImageUrl(alt);
    }
    const card = document.createElement('div');
    card.className = 'catcard';
    card.innerHTML = `
      <div class="left">
        ${cover ? `<div class="catimg" style="background-image:url('${cover}')"></div>` : `<div class="emoji">üõçÔ∏è</div>`}
        <div>
          <div class="name">${cat}</div>
          <div class="count">${block.items.length} producto${block.items.length!==1?'s':''}</div>
        </div>
      </div>
      <div>‚Üí</div>`;
    card.onclick = ()=>{
      state.category = cat;
      showView('products');
      $('#catTitle').textContent = cat;
      renderCategories();
      renderGrid();
    };
    host.appendChild(card);
  });
  if(!INDEX.length){ host.innerHTML = `<p class="muted">No hay categor√≠as disponibles.</p>`; }
}

/************ LISTADO DE PRODUCTOS ************/
function productMatches(p){
  const hayCat = (state.category==='Todo') || (p.category === state.category);
  const haySearch = !state.search || (p.name + ' ' + (p.description||'')).toLowerCase().includes(state.search.toLowerCase());
  return hayCat && haySearch;
}
function currentItems(){
  const base = (state.category==='Todo'|| !state.category) ? allItems() : (DATA[state.category]?.items||[]);
  return base.filter(productMatches);
}
function renderGrid(){
  const grid = $('#grid');
  grid.innerHTML = '';
  const items = currentItems();

  items.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';

    const thumb = document.createElement('div');
    const img = normalizeImageUrl(p.imageUrl);
    thumb.className = 'thumb' + (img ? ' hasimg' : '');
    if(img) thumb.style.backgroundImage = `url('${img}')`;
    else thumb.textContent = 'üõçÔ∏è';

    const content = document.createElement('div');
    content.className = 'content';
    content.innerHTML = `
      <h3 class="title">${p.name}</h3>
      <div class="desc">${p.description||''}</div>
      <div class="muted" style="margin:6px 0 8px">${p.category||''}</div>
      <div class="row-s" style="margin-bottom:8px; gap:8px">
        <select aria-label="Presentaci√≥n" data-sel>
          ${(p.variants||[]).map((v,i)=>`<option value="${i}">${v.label} ‚Äî ${fmt.format(+v.price||0)}</option>`).join('')}
        </select>
      </div>
      <div class="actions">
        <button class="btn" data-minus>-</button>
        <input type="number" min="1" value="1" style="width:70px; text-align:center" data-qty />
        <button class="btn" data-plus>+</button>
        <button class="btn primary" data-add>Agregar</button>
      </div>`;

    const qty = content.querySelector('[data-qty]');
    content.querySelector('[data-minus]').onclick = ()=> qty.value = Math.max(1, Number(qty.value)-1);
    content.querySelector('[data-plus]').onclick = ()=> qty.value = Number(qty.value)+1;
    content.querySelector('[data-add]').onclick = ()=>{
      const variantIndex = Number(content.querySelector('[data-sel]').value || 0);
      addToCart(p, variantIndex, Number(qty.value||1));
    };

    card.appendChild(thumb);
    card.appendChild(content);
    grid.appendChild(card);
  });

  if(!items.length){
    grid.innerHTML = `<p class="muted">No hay productos que coincidan.</p>`;
  }
}

/************ NAVEGACI√ìN DE VISTAS ************/
function showView(v){
  state.view = v;
  $('#placeSelect').style.display = (v==='places') ? '' : 'none';
  $('#homeCats').style.display  = (v==='home') ? '' : 'none';
  $('#productList').style.display = (v==='products') ? '' : 'none';
  renderCategories();
}

/************ CARRITO ************/
function addToCart(product, variantIndex, quantity=1){
  const v = (product.variants||[])[variantIndex] || (product.variants||[])[0];
  if(!v) return;
  const key = `${product.id}__${v.sku || v.label}`;
  const existing = state.cart.find(i=>i.key===key);
  if(existing){ existing.qty += quantity; }
  else {
    // Incluimos el c√≥digo de variante si existiera (tu JSON lo trae como "cod" -> ac√° uso "code")
    const possibleCode = v.code ?? v.cod ?? v.sku ?? null;
    state.cart.push({
      key, productId:product.id, name:product.name,
      code:possibleCode, variant:v.label, price:+v.price||0, qty:quantity
    });
  }
  saveCart(); renderCart();
}

function changeQty(key, delta){
  const item = state.cart.find(i=>i.key===key); if(!item) return;
  item.qty += delta;
  if(item.qty <= 0){ state.cart = state.cart.filter(i=>i.key!==key); }
  saveCart(); renderCart();
}
function removeItem(key){ state.cart = state.cart.filter(i=>i.key!==key); saveCart(); renderCart(); }
function clearCart(){ state.cart = []; saveCart(); renderCart(); }

function subtotal(){ return state.cart.reduce((s,i)=> s + i.price * i.qty, 0); }
function selectedShipping(){ return STORE.shippingOptions.find(o=>o.id===state.shipping) || STORE.shippingOptions[0]; }

function renderCart(){
  // badge
  const count = state.cart.reduce((s,i)=> s + i.qty, 0);
  $('#cartCount').textContent = count;

  // shipping select
  const sel = $('#shippingSelect');
  sel.innerHTML = STORE.shippingOptions.map(o=>`<option value="${o.id}">${o.label} ‚Äî ${fmt.format(o.price)}</option>`).join('');
  sel.value = state.shipping;
  sel.onchange = e=>{ state.shipping = e.target.value; updateTotals(); };

  // lines
  const host = $('#cartLines');
  host.innerHTML = '';
  if(state.cart.length===0){
    host.innerHTML = `<p class="muted">Tu carrito est√° vac√≠o.</p>`;
  } else {
    state.cart.forEach(i=>{
      const line = document.createElement('div');
      line.className = 'line';
      line.innerHTML = `
        <div>
          <div style="font-weight:700">${i.name} <span class="muted">(${i.variant})</span></div>
          <div class="muted">${fmt.format(i.price)} c/u</div>
          <button class="remove" aria-label="Quitar">Quitar</button>
        </div>
        <div class="qty">
          <button class="btn" aria-label="Menos">-</button>
          <strong>${i.qty}</strong>
          <button class="btn" aria-label="M√°s">+</button>
        </div>`;
      const [minusBtn, plusBtn] = line.querySelectorAll('.qty .btn');
      minusBtn.onclick = ()=> changeQty(i.key, -1);
      plusBtn.onclick = ()=> changeQty(i.key, +1);
      line.querySelector('.remove').onclick = ()=> removeItem(i.key);
      host.appendChild(line);
    });
  }
  updateTotals();
}

function updateTotals(){
  const sub = subtotal();
  const ship = (sub >= STORE.freeShippingMin && STORE.freeShippingMin>0) ? 0 : selectedShipping().price;
  const total = sub + ship;
  $('#subtotal').textContent = fmt.format(sub);
  $('#shippingCost').textContent = fmt.format(ship);
  $('#grandTotal').textContent = fmt.format(total);
}

/************ WHATSAPP ************/
function buildWhatsAppURL(){
  if(!STORE.phone || STORE.phone.replace(/\D/g,'').length < 10){
    alert('Configur√° tu n√∫mero de WhatsApp en STORE.phone (formato internacional).');
    return '#';
  }
  if(state.cart.length===0){ alert('Tu carrito est√° vac√≠o.'); return '#'; }

  const cust = {
    name: $('#custName').value.trim(),
    area: $('#custArea').value.trim(),
    address: $('#custAddress').value.trim(),
    notes: $('#notes').value.trim()
  };
  const sub = subtotal();
  const ship = (sub >= STORE.freeShippingMin && STORE.freeShippingMin>0) ? 0 : selectedShipping().price;
  const total = sub + ship;

  const items = state.cart
    .map(i=>`‚Ä¢ ${i.name} (${i.variant}) x${i.qty} ‚Äî ${fmt.format(i.price*i.qty)}`)
    .join('%0A');

  const msg = [
    `Hola ${STORE.name}! Quiero hacer un pedido:`,
    items,
    `Subtotal: ${fmt.format(sub)}`,
    `Env√≠o: ${selectedShipping().label} ‚Äî ${fmt.format(ship)}`,
    `TOTAL: ${fmt.format(total)}`,
    '',
    `Lugar: ${state.placeName || '-'}`,
    `Nombre: ${cust.name || '-'}`,
    `Zona: ${cust.area || '-'}`,
    `Direcci√≥n: ${cust.address || '-'}`,
    cust.notes ? `Notas: ${cust.notes}` : ''
  ].join('%0A');

  return `https://wa.me/${STORE.phone}?text=${msg}`;
}

/************ INIT ************/
async function init(){
  // Nombre base
  $('#storeName').textContent = STORE.name;

  // Buscar: si tipe√°s en lugares no se mueve; en home va a productos (Todo)
  $('#searchInput').addEventListener('input', e=>{
    state.search = e.target.value;
    if(state.view==='home'){
      state.category = 'Todo';
      renderGrid();
    }
    if(state.view==='products'){
      renderGrid();
    }
  });

  // Drawer carrito
  const drawer = $('#drawer');
  $('#openCartBtn').onclick = ()=>{ drawer.classList.add('open'); renderCart(); };
  $('#closeCartBtn').onclick = ()=> drawer.classList.remove('open');

  // Acciones carrito
  $('#clearBtn').onclick = ()=>{ if(confirm('¬øVaciar carrito?')) clearCart(); };
  $('#whatsBtn').onclick = ()=>{
    const url = buildWhatsAppURL();
    if(url && url !== '#') window.open(url, '_blank');
  };

  // Botones navegaci√≥n
  $('#changePlaceBtn').onclick = ()=>{ showView('places'); };
  $('#changePlaceBtn2').onclick = ()=>{ showView('places'); };
  $('#backToCatsBtn').onclick = ()=>{ showView('home'); renderCategories(); };

  // Render inicial
  showView('places');
  await fetchPlacesMeta();
  renderCart();
}
init();
</script>
</body>
</html>
