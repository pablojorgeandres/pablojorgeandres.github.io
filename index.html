<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Nim√∫ - Consumo con sentido</title>
  <meta name="description" content="Cat√°logo simple con carrito y pedido por WhatsApp. HTML, CSS y JS puros." />
  <link rel="icon" type="image/jpeg" href="imgs/nimuicon.jpg">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="brand"><i><img src="imgs/nimuicon.jpg" alt="Nim√∫" class="brand-icon"></i> <span id="storeName">Nim√∫ - Consumo con sentido</span></div>
        <div class="search">
          <input id="searchInput" type="search" placeholder="Buscar productos en todas las categor√≠as..." />
        </div>
        <button class="fab" id="openCartBtn" aria-label="Abrir carrito">üõí <span class="badge" id="cartCount">0</span></button>
      </div>
      <div class="pillbar" id="catBar"></div>
    </div>
  </header>

  <main>
    <!-- Capa 0: selecci√≥n de lugar -->
    <section id="placeSelect">
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <h2 style="margin:8px 0 12px">Eleg√≠ tu lugar</h2>
      </div>
      <div class="placesgrid" id="placesGrid"></div>
    </section>

    <!-- Home: mosaico de categor√≠as -->
    <section id="homeCats" style="display:none">
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div>
          <h2 style="margin:8px 0 12px">Explor√° por categor√≠a</h2>
          <div class="muted" id="placeBadge" style="margin-top:-6px"></div>
        </div>
        <button class="linkbtn" id="changePlaceBtn">Cambiar lugar</button>
      </div>
      <div class="catsgrid" id="catsGrid"></div>
    </section>

    <!-- Listado de productos dentro de una categor√≠a -->
    <section id="productList" style="display:none">
      <div class="header-content">
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="backToCatsBtn">‚Üê Categor√≠as</button>
          <button class="linkbtn" id="changePlaceBtn2">Cambiar lugar</button>
        </div>
          <div class="muted" id="catTitle" style="font-size:18px; font-weight:700"></div>
        </div>
      </div>
      <div class="grid" id="grid"></div>
    </section>
  </main>

  <!-- Drawer del carrito -->
  <aside class="drawer" id="drawer">
    <header>
      <strong>Tu carrito</strong>
      <button class="btn" id="closeCartBtn">‚úï</button>
    </header>
    <main>
      <div id="cartLines"></div>

      <h4>Datos para el pedido</h4>
      <div class="line" style="grid-template-columns:1fr;">
        <input id="custName" placeholder="Tu nombre" />
        <input id="custArea" placeholder="Barrio / Localidad" style="margin-top:8px" />
        <input id="custAddress" placeholder="Direcci√≥n (Calle - Provincia - CP)" style="margin-top:8px" />
        <input id="custPhone" placeholder="Tel√©fono" style="margin-top:8px" />
      </div>

      <div class="line" style="grid-template-columns:1fr;">
        <select id="shippingSelect" class="select"></select>
        <textarea id="notes" class="notes" placeholder="Observaciones (horario, cambios, sin sal, etc.)"></textarea>
      </div>
    </main>

    <div class="totals">
      <div class="row"><span>Subtotal</span><strong id="subtotal">$0</strong></div>
      <div class="row"><span>Env√≠o</span><strong id="shippingCost">$0</strong></div>
      <div class="row"><span>Total</span><strong id="grandTotal">$0</strong></div>
      <div class="cta">
        <button class="btn" id="clearBtn">Vaciar</button>
        <button class="btn primary" id="whatsBtn">Enviar por WhatsApp</button>
      </div>
    </div>
  </aside>

  <footer>
    Hecho con ‚ù§Ô∏è en HTML + JS. Contacto: <em>pablojorgeandres@gmail.com</em>
  </footer>

<script>
/************ CONFIG ************/
const STORE = {
  name: 'Nim√∫ - Consumo con sentido',
  personalName: 'Anto',
  phone: '5493425325683',
  currency: 'ARS',
  freeShippingMin: 30000,
  shippingOptions: [
    { id:'Env√≠o', label:'Env√≠o sin costo', price:0 },
  ]
};

// TU endpoint de Apps Script (termina en /exec)
const PRODUCTS_URL = 'https://script.google.com/macros/s/AKfycbykFiNmtfbVMKDWhD6JDP-R_R8M-e5wszwfum4eHokTBF3ey9y1eatSiKSPNADx_L47/exec';

/**
 * Siluetas (placeholders) ‚Äì reemplaz√° por tus contornos si quer√©s.
 * Pod√©s usar PNG/SVG externos o data-URIs.
 */
const PLACE_SHAPES = {
  santafe: 'https://drive.google.com/thumbnail?id=1o8eKJyWCRDHvVV2CbYHGxQbgmrcml0cg&sz=w800',
  buenosaires: 'https://drive.google.com/thumbnail?id=11RLU0gQ7NDfTPZnKqEQT1F2qq_vaCAqK&sz=w800'
};

/************ DATA ************/
let DATA = {};        // cat√°logo por categor√≠a
let INDEX = [];       // lista de categor√≠as
let PLACES_META = []; // [{id,name}]
let state = {
  view: 'places',     // 'places' | 'home' | 'products'
  place: null,        // 'santafe' | 'buenosaires'
  placeName: '',
  category: null,     // null| 'Frutos Secos' | 'Todo'
  search: '',
  cart: loadCart(),
  shipping: STORE.shippingOptions[0].id
};

/************ UTIL ************/
const fmt = new Intl.NumberFormat('es-AR', { style:'currency', currency: STORE.currency });
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const encode = s => encodeURIComponent(s);

function loadCart(){ try{ return JSON.parse(localStorage.getItem('cart')) || []; } catch { return []; } }
function saveCart(){ localStorage.setItem('cart', JSON.stringify(state.cart)); }

function allItems(){ return INDEX.flatMap(cat => (DATA[cat]?.items)||[]); }

// Funci√≥n para limpiar cache (√∫til para debug)
function clearCache() {
  const keys = Object.keys(localStorage);
  const removed = keys.filter(key => key.startsWith('categories_') || key.startsWith('products_') || key.startsWith('catalog_'));
  removed.forEach(key => localStorage.removeItem(key));
  console.log('üßπ Cache limpiado:', removed);
  return removed.length;
}

/************ SKELETON LOADING ************/
function createCategoriesSkeleton(count = 8) {
  const skeletons = [];
  for (let i = 0; i < count; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton-catcard';
    skeleton.innerHTML = `
      <div class="skeleton-left">
        <div class="skeleton-catimg skeleton"></div>
        <div class="skeleton-catinfo">
          <div class="skeleton-catname skeleton"></div>
          <div class="skeleton-catcount skeleton"></div>
        </div>
      </div>
      <div class="skeleton-arrow skeleton"></div>`;
    skeletons.push(skeleton);
  }
  return skeletons;
}

function createProductsSkeleton(count = 6) {
  const skeletons = [];
  for (let i = 0; i < count; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton-card';
    skeleton.innerHTML = `
      <div class="skeleton-thumb skeleton"></div>
      <div class="skeleton-content">
        <div class="skeleton-title skeleton"></div>
        <div class="skeleton-desc skeleton"></div>
        <div class="skeleton-desc skeleton"></div>
        <div class="skeleton-category skeleton"></div>
        <div class="skeleton-price-row">
          <div class="skeleton-select skeleton"></div>
        </div>
        <div class="skeleton-actions">
          <div class="skeleton-btn skeleton"></div>
          <div class="skeleton-btn skeleton"></div>
          <div class="skeleton-btn skeleton"></div>
          <div class="skeleton-btn skeleton"></div>
        </div>
      </div>`;
    skeletons.push(skeleton);
  }
  return skeletons;
}

function showCategoriesSkeleton() {
  const host = $('#catsGrid');
  host.innerHTML = '';
  const skeletons = createCategoriesSkeleton(8);
  skeletons.forEach(skeleton => host.appendChild(skeleton));
}

function showProductsSkeleton() {
  const host = $('#grid');
  host.innerHTML = '';
  const skeletons = createProductsSkeleton(6);
  skeletons.forEach(skeleton => host.appendChild(skeleton));
}

function createPlacesSkeleton(count = 2) {
  const skeletons = [];
  for (let i = 0; i < count; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton-placecard';
    skeleton.innerHTML = `
      <div class="skeleton-placeimg skeleton"></div>
      <div class="skeleton-placename skeleton"></div>
      <div class="skeleton-placedesc skeleton"></div>`;
    skeletons.push(skeleton);
  }
  return skeletons;
}

function showPlacesSkeleton() {
  const host = $('#placesGrid');
  host.innerHTML = '';
  const skeletons = createPlacesSkeleton(2);
  skeletons.forEach(skeleton => host.appendChild(skeleton));
}

// Precargar una imagen y retornar Promise
function preloadImage(url) {
  return new Promise((resolve, reject) => {
    if (!url) {
      resolve(); // Si no hay URL, resolver inmediatamente
      return;
    }
    const img = new Image();
    img.onload = () => resolve();
    img.onerror = () => resolve(); // Resolver incluso si falla para no bloquear
    img.src = url;
  });
}

// Precargar todas las im√°genes de categor√≠as
async function preloadCategoryImages() {
  const imageUrls = [];
  
  INDEX.forEach(cat => {
    const block = DATA[cat] || {cover:'', count: 0};
    let cover = normalizeImageUrl(block.cover || '');
    if (cover) {
      imageUrls.push(cover);
    }
  });
  
  // Esperar a que todas las im√°genes se precarguen
  await Promise.all(imageUrls.map(url => preloadImage(url)));
}

function normalizeImageUrl(u, size=800){
  if(!u) return "";
  if(u.includes("drive.google.com/thumbnail")) return u;
  const m = u.match(/[?&]id=([A-Za-z0-9_-]+)/) || u.match(/\/d\/([A-Za-z0-9_-]+)/);
  const id = m ? m[1] : null;
  return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w${size}` : u;
}

function sanitizeCatalog(data){
  const out = {};
  Object.keys(data || {}).forEach(cat=>{
    const block = data[cat] || {};
    const items = Array.isArray(block.items) ? [...block.items] : [];

    // sentinel para cover
    const idx = items.findIndex(p =>
      String(p?.name||'').trim().toLowerCase() === 'categoryimage' ||
      String(p?.id||'').trim().toLowerCase() === '_cover'
    );

    if (idx >= 0) {
      const raw = items[idx].imageUrl || '';
      block.cover = normalizeImageUrl(raw);
      items.splice(idx, 1);
    }
    if (block.cover) block.cover = normalizeImageUrl(block.cover);

    block.items = items;
    out[cat] = block;
  });
  return out;
}

/************ FETCH ************/
async function fetchPlacesMeta(){
  // Mostrar skeleton mientras carga lugares
  showPlacesSkeleton();
  
  let safeList = [
    { id: 'santafe', name: 'Santa Fe' },
    { id: 'buenosaires', name: 'Buenos Aires' }
  ];
  try{
    const res = await fetch(`${PRODUCTS_URL}?meta=places&bust=${Date.now()}`, { cache:'no-store' });
    const data = await res.json();
    const looksOk = Array.isArray(data) && data.length &&
      data.every(x => x && typeof x.id === 'string' && typeof x.name === 'string');
    if (looksOk) safeList = data;
  } catch(e){
    console.warn('Usando fallback de lugares:', e);
  }
  PLACES_META = safeList;
  renderPlaces();
}

async function fetchCategoriesForPlace(placeId){
  // Mostrar skeleton mientras carga
  if (state.view === 'home') showCategoriesSkeleton();
  
  const cacheKey = `categories_v2__${placeId}`;  // Cambi√© v1 -> v2 para limpiar cache
  // 1) cache local
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    try {
      DATA = JSON.parse(cached);
      INDEX = Object.keys(DATA);
      if (state.view === 'home') await renderHomeCats();
      return;
    } catch(e) { console.warn('Cache corrupta, la ignoro', e); }
  }

  // 2) pedir fresco - solo categor√≠as
  const res = await fetch(`${PRODUCTS_URL}?action=categories&place=${encode(placeId)}&bust=${Date.now()}`, { cache:'no-store' });
  const fresh = await res.json();
  
  // Debug: mostrar qu√© datos llegaron
  console.log('üìä Datos de categor√≠as recibidos:', fresh);
  console.log('üìù Nombres de categor√≠as:', Object.keys(fresh));
  
  DATA = fresh;
  INDEX = Object.keys(DATA);
  localStorage.setItem(cacheKey, JSON.stringify(DATA));
  if (state.view === 'home') await renderHomeCats();
}

async function fetchProductsForCategory(placeId, category){
  // Mostrar skeleton mientras carga productos
  showProductsSkeleton();
  
  const cacheKey = `products_v2__${placeId}__${category}`;  // Cambi√© v1 -> v2 para cache fresh
  // 1) cache local
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    try {
      const products = JSON.parse(cached);
      DATA[category] = { ...DATA[category], items: products };
      renderGrid();
      return;
    } catch(e) { console.warn('Cache corrupta, la ignoro', e); }
  }

  // 2) pedir fresco - productos de una categor√≠a
  const res = await fetch(`${PRODUCTS_URL}?action=products&place=${encode(placeId)}&category=${encode(category)}&bust=${Date.now()}`, { cache:'no-store' });
  const products = await res.json();
  localStorage.setItem(cacheKey, JSON.stringify(products));
  
  // Actualizar DATA con los productos cargados
  if (!DATA[category]) DATA[category] = {};
  DATA[category].items = products;
  renderGrid();
}

async function performGlobalSearch(query) {
  const catsGrid = $('#catsGrid');
  
  // Mostrar skeleton mientras busca
  showCategoriesSkeleton();
  
  try {
    const url = `${PRODUCTS_URL}?action=search&place=${state.place}&q=${encode(query)}&bust=${Date.now()}`;
    const resp = await fetch(url, { cache:'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    
    const products = await resp.json();
    
    // Renderizar resultados como tarjetas de productos
    renderSearchResults(products);
  } catch (err) {
    console.error('Error en b√∫squeda global:', err);
    catsGrid.innerHTML = `<p class="muted">Error al buscar productos</p>`;
  }
}

function buildProductCard(p) {
  const card = document.createElement('div');
  card.className = 'card';

  const thumb = document.createElement('div');
  const img = normalizeImageUrl(p.imageUrl);
  thumb.className = 'thumb' + (img ? ' hasimg' : '');
  if(img) thumb.style.backgroundImage = `url('${img}')`;
  else thumb.textContent = 'üõçÔ∏è';

  const content = document.createElement('div');
  content.className = 'content';
  content.innerHTML = `
    <h3 class="title">${p.name}</h3>
    <div class="desc">${p.description||''}</div>
    <div class="muted" style="margin:6px 0 8px">${p.category||''}</div>
    <div class="row-s" style="margin-bottom:8px; gap:8px">
      <select aria-label="Presentaci√≥n" data-sel>
        ${(p.variants||[]).map((v,i)=>`<option value="${i}">${v.label} ‚Äî ${fmt.format(+v.price||0)}</option>`).join('')}
      </select>
    </div>
    <div class="actions">
      <button class="btn" data-minus>-</button>
      <input type="number" min="1" value="1" style="width:70px; text-align:center" data-qty />
      <button class="btn" data-plus>+</button>
      <button class="btn primary" data-add>Agregar</button>
    </div>`;

  const qty = content.querySelector('[data-qty]');
  content.querySelector('[data-minus]').onclick = ()=> qty.value = Math.max(1, Number(qty.value)-1);
  content.querySelector('[data-plus]').onclick = ()=> qty.value = Number(qty.value)+1;
  content.querySelector('[data-add]').onclick = ()=>{
    const variantIndex = Number(content.querySelector('[data-sel]').value || 0);
    addToCart(p, variantIndex, Number(qty.value||1));
  };

  card.appendChild(thumb);
  card.appendChild(content);
  return card;
}

function renderSearchResults(products) {
  const catsGrid = $('#catsGrid');
  
  if (!products || products.length === 0) {
    catsGrid.innerHTML = `<p class="muted">No se encontraron productos</p>`;
    return;
  }
  
  // Cambiar a grid de productos (usar clase .grid en lugar de .catsgrid)
  catsGrid.className = 'grid';
  catsGrid.innerHTML = '';
  
  products.forEach(p => {
    const card = buildProductCard(p);
    catsGrid.appendChild(card);
  });
}

/************ UI: LUGARES ************/
function renderPlaces(){
  const host = $('#placesGrid');
  host.innerHTML = '';

  // Si el backend todav√≠a no define lugares, usamos fallback fijo:
  const list = PLACES_META && PLACES_META.length ? PLACES_META : [
    { id: 'santafe', name: 'Santa Fe' },
    { id: 'buenosaires', name: 'Buenos Aires' }
  ];

  list.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'placecard';
    const bg = PLACE_SHAPES[p.id] || '';
    card.innerHTML = `
      <div class="placeimg" style="${bg ? `background-image:url('${bg}')` : ''}"></div>
      <div class="placename">${p.name}</div>
      <div class="muted">Ver productos disponibles en ${p.name}</div>`;
    card.onclick = async ()=>{
      state.place = p.id;
      state.placeName = p.name;
      $('#placeBadge').textContent = `Lugar: ${state.placeName}`;
      $('#storeName').textContent = `${STORE.name} ‚Äî ${state.placeName}`;
      state.category = null;
      state.search = '';
      showView('home');
      await fetchCategoriesForPlace(state.place);
      renderCategories();
    };
    host.appendChild(card);
  });
  if(!list.length){ host.innerHTML = `<p class="muted">No hay lugares disponibles.</p>`; }
}

/************ UI: CATEGOR√çAS (p√≠ldoras) ************/
function renderCategories(){
  const bar = $('#catBar');
  bar.innerHTML = '';
  if(state.view !== 'products'){ bar.style.display = 'none'; return; }

  INDEX.forEach(c=>{
    const b = document.createElement('button');
    b.className = 'pill' + ((state.category===c)?' active':'');
    b.textContent = c;
    b.onclick = async ()=>{
      state.category = c;
      $('#catTitle').textContent = c;
      highlightCat();
      if (!DATA[c]?.items) {
        await fetchProductsForCategory(state.place, c);
      } else {
        renderGrid();
      }
    };
    bar.appendChild(b);
  });
  bar.style.display = 'flex';
  
  // Actualizar contenido del header
  if (state.placeName) {
    $('#placeBadge').textContent = `Lugar: ${state.placeName}`;
  }
}
function highlightCat(){ $$('#catBar .pill').forEach(el=>{ el.classList.toggle('active', el.textContent===state.category); }); }

/************ HOME: MOSAICO DE CATEGOR√çAS ************/
async function renderHomeCats(){
  const host = $('#catsGrid');
  
  // Asegurar que estamos en modo categor√≠as
  host.className = 'catsgrid';
  
  // Debug: mostrar qu√© categor√≠as se van a renderizar
  console.log('üé® Renderizando categor√≠as:', INDEX);
  console.log('üìã DATA completa:', DATA);
  
  // Si no hay categor√≠as, mostrar mensaje
  if(!INDEX.length){ 
    console.log('‚ùå No hay categor√≠as en INDEX');
    host.innerHTML = `<p class="muted">No hay categor√≠as disponibles.</p>`; 
    return;
  }
  
  // Precargar todas las im√°genes antes de renderizar
  await preloadCategoryImages();
  
  // Ahora renderizar todo junto
  host.innerHTML = '';
  INDEX.forEach(cat=>{
    console.log(`üè∑Ô∏è Procesando categor√≠a: "${cat}"`);
    const block = DATA[cat] || {cover:'', count: 0};
    let cover = normalizeImageUrl(block.cover || '');
    const card = document.createElement('div');
    card.className = 'catcard';
    card.innerHTML = `
      <div class="left">
        ${cover ? `<div class="catimg" style="background-image:url('${cover}')"></div>` : `<div class="emoji">üõçÔ∏è</div>`}
        <div>
          <div class="name">${cat}</div>
          <div class="count">${block.count || 0} producto${(block.count || 0)!==1?'s':''}</div>
        </div>
      </div>
      <div class="arrow">‚Üí</div>`;
    card.onclick = async ()=>{
      state.category = cat;
      showView('products');
      $('#catTitle').textContent = cat;
      renderCategories();
      if (!DATA[cat]?.items) {
        await fetchProductsForCategory(state.place, cat);
      } else {
      renderGrid();
      }
    };
    host.appendChild(card);
  });
}

/************ LISTADO DE PRODUCTOS ************/
function productMatches(p){
  const haySearch = !state.search || (p.name + ' ' + (p.description||'')).toLowerCase().includes(state.search.toLowerCase());
  return haySearch;
}
function currentItems(){
  if (!state.category) return [];
  const base = DATA[state.category]?.items || [];
  return base.filter(productMatches);
}
function renderGrid(){
  const grid = $('#grid');
  grid.innerHTML = '';
  const items = currentItems();

  // Si no hay categor√≠a seleccionada, mostrar mensaje
  if (!state.category) {
    grid.innerHTML = `<p class="muted">Selecciona una categor√≠a para ver productos.</p>`;
    return;
  }

  items.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';

    const thumb = document.createElement('div');
    const img = normalizeImageUrl(p.imageUrl);
    thumb.className = 'thumb' + (img ? ' hasimg' : '');
    if(img) thumb.style.backgroundImage = `url('${img}')`;
    else thumb.textContent = 'üõçÔ∏è';

    const content = document.createElement('div');
    content.className = 'content';
    content.innerHTML = `
      <h3 class="title">${p.name}</h3>
      <div class="desc">${p.description||''}</div>
      <div class="muted" style="margin:6px 0 8px">${p.category||''}</div>
      <div class="row-s" style="margin-bottom:8px; gap:8px">
        <select aria-label="Presentaci√≥n" data-sel>
          ${(p.variants||[]).map((v,i)=>`<option value="${i}">${v.label} ‚Äî ${fmt.format(+v.price||0)}</option>`).join('')}
        </select>
      </div>
      <div class="actions">
        <button class="btn" data-minus>-</button>
        <input type="number" min="1" value="1" style="width:70px; text-align:center" data-qty />
        <button class="btn" data-plus>+</button>
        <button class="btn primary" data-add>Agregar</button>
      </div>`;

    const qty = content.querySelector('[data-qty]');
    content.querySelector('[data-minus]').onclick = ()=> qty.value = Math.max(1, Number(qty.value)-1);
    content.querySelector('[data-plus]').onclick = ()=> qty.value = Number(qty.value)+1;
    content.querySelector('[data-add]').onclick = ()=>{
      const variantIndex = Number(content.querySelector('[data-sel]').value || 0);
      addToCart(p, variantIndex, Number(qty.value||1));
    };

    card.appendChild(thumb);
    card.appendChild(content);
    grid.appendChild(card);
  });

  if(!items.length){
    grid.innerHTML = `<p class="muted">No hay productos que coincidan.</p>`;
  }
}

/************ NAVEGACI√ìN DE VISTAS ************/
function showView(v){
  state.view = v;
  $('#placeSelect').style.display = (v==='places') ? '' : 'none';
  $('#homeCats').style.display  = (v==='home') ? '' : 'none';
  $('#productList').style.display = (v==='products') ? '' : 'none';
  
  // Limpiar b√∫squeda al cambiar de vista
  $('#searchInput').value = '';
  state.search = '';
  
  // Mostrar/ocultar buscador seg√∫n la vista
  const searchElement = $('.search');
  if (v === 'places') {
    searchElement.classList.add('hidden');
  } else {
    searchElement.classList.remove('hidden');
  }
  
  // Limpiar contenido al cambiar de vista para evitar contenido stale
  if (v === 'home') {
    $('#catsGrid').innerHTML = '';
    // Si no hay categor√≠as cargadas, mostrar skeleton
    if (!INDEX.length) {
      showCategoriesSkeleton();
    }
  } else if (v === 'products') {
    $('#grid').innerHTML = '';
  }
  
  renderCategories();
}

/************ CARRITO ************/
function addToCart(product, variantIndex, quantity=1){
  const v = (product.variants||[])[variantIndex] || (product.variants||[])[0];
  if(!v) return;
  const key = `${product.id}__${v.sku || v.label}`;
  const existing = state.cart.find(i=>i.key===key);
  if(existing){ existing.qty += quantity; }
  else {
    // Incluimos el c√≥digo de variante si existiera (tu JSON lo trae como "cod" -> ac√° uso "code")
    const possibleCode = v.code ?? v.cod ?? v.sku ?? null;
    state.cart.push({
      key, productId:product.id, name:product.name,
      code:possibleCode, variant:v.label, price:+v.price||0, qty:quantity
    });
  }
  saveCart(); renderCart();
}

function changeQty(key, delta){
  const item = state.cart.find(i=>i.key===key); if(!item) return;
  item.qty += delta;
  if(item.qty <= 0){ state.cart = state.cart.filter(i=>i.key!==key); }
  saveCart(); renderCart();
}
function removeItem(key){ state.cart = state.cart.filter(i=>i.key!==key); saveCart(); renderCart(); }
function clearCart(){ state.cart = []; saveCart(); renderCart(); }

function subtotal(){ return state.cart.reduce((s,i)=> s + i.price * i.qty, 0); }
function selectedShipping(){ return STORE.shippingOptions.find(o=>o.id===state.shipping) || STORE.shippingOptions[0]; }

function renderCart(){
  // badge
  const count = state.cart.reduce((s,i)=> s + i.qty, 0);
  $('#cartCount').textContent = count;

  // shipping select
  const sel = $('#shippingSelect');
  sel.innerHTML = STORE.shippingOptions.map(o=>`<option value="${o.id}">${o.label} ‚Äî ${fmt.format(o.price)}</option>`).join('');
  sel.value = state.shipping;
  sel.onchange = e=>{ state.shipping = e.target.value; updateTotals(); };

  // lines
  const host = $('#cartLines');
  host.innerHTML = '';
  if(state.cart.length===0){
    host.innerHTML = `<p class="muted">Tu carrito est√° vac√≠o.</p>`;
  } else {
    state.cart.forEach(i=>{
      const line = document.createElement('div');
      line.className = 'line';
      line.innerHTML = `
        <div>
          <div style="font-weight:700">${i.name} <span class="muted">(${i.variant})</span></div>
          <div class="muted">${fmt.format(i.price)} c/u</div>
          <button class="remove" aria-label="Quitar">Quitar</button>
        </div>
        <div class="qty">
          <button class="btn" aria-label="Menos">-</button>
          <strong>${i.qty}</strong>
          <button class="btn" aria-label="M√°s">+</button>
        </div>`;
      const [minusBtn, plusBtn] = line.querySelectorAll('.qty .btn');
      minusBtn.onclick = ()=> changeQty(i.key, -1);
      plusBtn.onclick = ()=> changeQty(i.key, +1);
      line.querySelector('.remove').onclick = ()=> removeItem(i.key);
      host.appendChild(line);
    });
  }
  updateTotals();
}

function updateTotals(){
  const sub = subtotal();
  const ship = (sub >= STORE.freeShippingMin && STORE.freeShippingMin>0) ? 0 : selectedShipping().price;
  const total = sub + ship;
  $('#subtotal').textContent = fmt.format(sub);
  $('#shippingCost').textContent = fmt.format(ship);
  $('#grandTotal').textContent = fmt.format(total);
}

/************ WHATSAPP ************/
function buildWhatsAppURL(){
  if(!STORE.phone || STORE.phone.replace(/\D/g,'').length < 10){
    alert('Configur√° tu n√∫mero de WhatsApp en STORE.phone (formato internacional).');
    return '#';
  }
  if(state.cart.length===0){ alert('Tu carrito est√° vac√≠o.'); return '#'; }

  const cust = {
    name: $('#custName').value.trim(),
    area: $('#custArea').value.trim(),
    address: $('#custAddress').value.trim(),
    phone: $('#custPhone').value.trim(),
    notes: $('#notes').value.trim()
  };
  const sub = subtotal();
  const ship = (sub >= STORE.freeShippingMin && STORE.freeShippingMin>0) ? 0 : selectedShipping().price;
  const total = sub + ship;

  const items = state.cart
    .map(i=>`‚Ä¢ ${i.name} (${i.variant}) x${i.qty} ‚Äî ${fmt.format(i.price*i.qty)}`)
    .join('%0A');

  const msg = [
    `Hola ${STORE.personalName}! Quiero hacer un pedido:`,
    '',
    items,
    '',
    `Subtotal: ${fmt.format(sub)}`,
    `Env√≠o: ${selectedShipping().label} ‚Äî ${fmt.format(ship)}`,
    `TOTAL: ${fmt.format(total)}`,
    '',
    `Nombre: ${cust.name || '-'}`,
    `Tel√©fono: ${cust.phone || '-'}`,
    `Direcci√≥n: ${cust.address || '-'}`,
    `Zona: ${cust.area || '-'}`,
    `Lugar: ${state.placeName || '-'}`,
    cust.notes ? `Notas: ${cust.notes}` : ''
  ].join('%0A');

  return `https://wa.me/${STORE.phone}?text=${msg}`;
}

/************ INIT ************/
async function init(){
  // Nombre base
  $('#storeName').textContent = STORE.name;

  // Buscar: funciona en vista de productos y b√∫squeda global en categor√≠as
  $('#searchInput').addEventListener('input', async e=>{
    state.search = e.target.value;
    
    // B√∫squeda en vista de productos (comportamiento actual)
    if(state.view==='products' && state.category){
      renderGrid();
    }
    
    // B√∫squeda global en vista de categor√≠as
    if(state.view==='home' && state.search.length >= 3){
      await performGlobalSearch(state.search);
    } else if(state.view==='home' && state.search.length < 3){
      // Restaurar categor√≠as si el usuario borra
      await renderHomeCats();
    }
  });

  // Drawer carrito
  const drawer = $('#drawer');
  $('#openCartBtn').onclick = ()=>{ drawer.classList.add('open'); renderCart(); };
  $('#closeCartBtn').onclick = ()=> drawer.classList.remove('open');

  // Acciones carrito
  $('#clearBtn').onclick = ()=>{ if(confirm('¬øVaciar carrito?')) clearCart(); };
  $('#whatsBtn').onclick = ()=>{
    const url = buildWhatsAppURL();
    if(url && url !== '#') window.open(url, '_blank');
  };

  // Botones navegaci√≥n
  $('#changePlaceBtn').onclick = ()=>{ showView('places'); };
  $('#changePlaceBtn2').onclick = ()=>{ showView('places'); };
  $('#backToCatsBtn').onclick = async ()=>{ 
    showView('home'); 
    renderCategories(); 
    // Renderizar las tarjetas de categor√≠as si ya est√°n cargadas
    if (INDEX.length > 0) {
      await renderHomeCats(); 
    }
  };
  

  // Render inicial
  showView('places');
  await fetchPlacesMeta();
  renderCart();
}
init();
</script>
</body>
</html>
